// Generated by CoffeeScript 1.9.3
(function() {
  var Const, Key, PassphraseBox, Random, SecretBox, crypto, ref;

  crypto = require("crypto");

  ref = require("sodium"), Const = ref.Const, SecretBox = ref.SecretBox, Key = ref.Key, Random = ref.Random;

  module.exports = PassphraseBox = (function() {
    var ITERATIONS;

    ITERATIONS = 10000;

    PassphraseBox.encrypt = function(passphrase, plaintext) {
      var box;
      box = new this({
        passphrase: passphrase
      });
      return box.encrypt(plaintext);
    };

    PassphraseBox.decrypt = function(passphrase, encrypted) {
      var box, ciphertext, iterations, nonce, salt;
      salt = encrypted.salt, iterations = encrypted.iterations, nonce = encrypted.nonce, ciphertext = encrypted.ciphertext;
      box = new this({
        passphrase: passphrase,
        salt: salt,
        iterations: iterations
      });
      return box.decrypt(ciphertext, nonce);
    };

    function PassphraseBox(arg) {
      var buffer, key, passphrase, salt;
      passphrase = arg.passphrase, salt = arg.salt, this.iterations = arg.iterations;
      if (salt) {
        this.salt = new Buffer(salt, "hex");
      } else {
        this.salt = new Buffer(16);
        Random.buffer(this.salt);
      }
      if (this.iterations == null) {
        this.iterations = ITERATIONS;
      }
      buffer = crypto.pbkdf2Sync(passphrase, this.salt, this.iterations, 32);
      key = new Key.SecretBox(buffer);
      this.box = new SecretBox(key);
    }

    PassphraseBox.prototype.encrypt = function(plaintext) {
      var cipherText, ciphertext, nonce, ref1;
      ref1 = this.box.encrypt(plaintext, "utf8"), cipherText = ref1.cipherText, nonce = ref1.nonce;
      ciphertext = cipherText.slice(16);
      return {
        iterations: this.iterations,
        salt: this.salt.toString("hex"),
        nonce: nonce.toString("hex"),
        ciphertext: ciphertext.toString("hex")
      };
    };

    PassphraseBox.prototype.decrypt = function(ciphertext, nonce) {
      var cipherText, plaintext;
      ciphertext = "00000000000000000000000000000000" + ciphertext;
      cipherText = new Buffer(ciphertext, "hex");
      nonce = new Buffer(nonce, "hex");
      plaintext = this.box.decrypt({
        cipherText: cipherText,
        nonce: nonce
      }, "utf8");
      if (plaintext == null) {
        throw new Error;
      }
      return plaintext;
    };

    return PassphraseBox;

  })();

}).call(this);
